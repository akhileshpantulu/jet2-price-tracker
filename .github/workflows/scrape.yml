# Scrapes Jet2holidays prices, saves pricing_data.json, then
# builds and deploys the dashboard â€” all in one workflow.
#
# Trigger manually: Actions tab â†’ "Scrape & Deploy" â†’ Run workflow
# Also runs automatically every 6 hours.

name: Scrape & Deploy

on:
  schedule:
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # ---- SCRAPE ----
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install requests

      - name: Run scraper
        run: python backend/scraper.py
        continue-on-error: true

      - name: Verify pricing data exists
        run: |
          if [ -f frontend/public/pricing_data.json ]; then
            echo "âœ… pricing_data.json found"
            cat frontend/public/pricing_data.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Hotels: {len(d.get(\"hotels\",[]))}, Prices: {d.get(\"total_prices\",0)}')"
          else
            echo "âš ï¸ No pricing data generated â€” scraper may have failed"
            echo "Creating empty placeholder..."
            mkdir -p frontend/public
            echo '{"hotels":[],"scraped_at":"'$(date -u +%Y-%m-%dT%H:%M:%S)'","total_prices":0,"error":"Scraper did not return data"}' > frontend/public/pricing_data.json
          fi

      - name: Commit pricing data to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frontend/public/pricing_data.json
          git diff --staged --quiet || git commit -m "ðŸ”„ Update pricing data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push || echo "Push failed â€” may be a permissions issue"

      # ---- BUILD ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      # ---- DEPLOY ----
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./frontend/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
